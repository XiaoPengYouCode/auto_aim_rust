# 估计器

## 问题描述

对一个有四块装甲板（分布在机器人底盘四周）的机器人的装甲板跟踪，同一时刻能看到一块或者两块，云台机构同时只能击打一块装甲板，在实战场景中，敌方的机器人会通过告诉旋转去规避击打，而估计器要做的是去寻找当前最优击打的那个装甲板，同时由于通信，子弹发射和飞行时间的限制，我需要去通过建模预测装甲板未来一段时间内会出现的位置，然后让我的枪口提前瞄准那个位置

## 大致描述

这个场景其实很复杂，首先装甲板被固定在机器人上，意味着如果我想要精确建模装甲板，预测其未来的位置，我需要对整车进行建模，而非对装甲板进行建模。但是我对车体的测量又只能由装甲板体现（因为车体没有明显特征，大家设计都不相同，游戏统一的规则就是安装四块装甲板分布在机器人底盘的四周，我们会通过神经网络的方式，具体是 `yolo-pose` 对装甲板及其特征点进行检测，然后通过 `pnp` 算法来求解出其在相机坐标系下的位姿），然后我会开始尝试通过装甲板来求解车体，具体又有两种情况

1. 只能看到一块装甲板偏正对，这个时候我会使用解算出的位姿和预测出的半径（刚开始给一个先验初始值，然后依靠模型去进行收敛）去反解车体的中心（相对不准确，`pnp` 的误差和估计出半径的误差）
2. 看到两块装甲板左右分布，采用两块装甲板解算出的位姿，从中心做反向投影，交点就是车体的中心（相对较准确，相当于有一些物理约束，但是 `pnp` 解算带来的误差依旧存在）

最终我去预测装甲板的位置，步骤如下

1. 先使用 `yolo-pose` 模型解算出装甲板的四个角点信息，然后利用 `pnp-ippe` 算法求解装甲板相对于相机的位姿
2. 根据装甲板解算结果解算整车的位姿
3. 将解算出整车的位姿作为车体 `eskf` 估计器的测量，负责在 `eskf` 步骤中对预测进行矫正
4. 基于动力学模型对整车进行预测（时间为火控延时+子弹发射时间）
5. 根据预测的整车结果反解出预测的装甲板的位置
6. 加入其他的偏置，例如重力补偿

## 前置条件

- 设备算力足够，算法全流程基本可以跑在100帧左右，高频的更新也保证了现有恒加速度滤波器设计基本已经覆盖大部分场景和部分边缘场景，达到我们的要求
- 比赛场景，光照条件基本固定，模型识别率也达到我们要求，优先不在模型层面做优化

## 滤波器设计

### 状态变量

1. `theta` 车体中心相对于世界坐标系的角度 `deg`
2. `distance` 敌方车体中心相对于己方中心的距离 `mm`
3. `v_tang` 切向速度 `mm/s`
4. `v_norm` 法向速度 `mm/s`
5. `v_spin` 陀螺速度 `deg/s
6. `a_lang` 切向加速度 `mm/s^2`
7. `a_norm` 法向加速度 `mm/s^2`
8. `a_spin` 陀螺加速度 `deg/s^2`
9. `armor_yaw` 追踪装甲板的 `yaw` 角 `deg`
10. `armor_r` 追踪装甲板的半径 `mm `
11. `armor_height` 追踪装甲板的高度  `mm`

### 测量变量

1. `theta` 车体中心相对于世界坐标系的角度 `degree`
2. `distance ` 敌方车体中心相对于己方中心的距离 `mm`
2. `armor_yaw` 追踪装甲板的 `yaw` 角
4. `armor_height` 追踪装甲板的高度 

- 特殊处理
  - 针对残差加入马氏距离检测，或进行卡方检验，或者高斯化，以提高测量的合理性


### 动力学模型

使用匀加速动力学模型即可，即认为加速度短期保持不变，对应速度和角速度均为线性变化，位置和角度均为二次变换，状态转移方程为：
$$
\begin{align*} 
theta(t+dt) &= theta(t) + v_{spin}(t)*dt + 0.5*a_{spin}(t)*dt^2 \\
distance(t+dt) &= distance(t) + v_{norm}(t)*dt + 0.5*a_{norm}(t)*dt^2 \\
v_{tang}(t+dt) &= v_{tang}(t) + a_{tang}(t)*dt \\
v_{norm}(t+dt) &= v_{norm}(t) + a_{norm}(t)*dt \\
v_{spin}(t+dt) &= v_{spin}(t) + a_{spin}(t)*dt \\
a_{tang}(t) &= (v_{tang}(t) - v_{tang}(t-dt)) / dt \\
a_{norm}(t) &= (v_{norm}(t) - v_{norm}(t-dt)) / dt \\
acc_{spin}(t) &= (v_{spin}(t) - v_{spin}(t-dt)) / dt \\
armor_{yaw}(t) &= armor_{yaw}(t-dt) + v_{spin} * dt \\
armor_{r}(t) &= armor_r(t-dt) \\
armor_{height}(t) &= armor_{height}(t-dt)
\end{align*}
$$

### 初始化逻辑

- 基于第一次测量
  1. `theta` 
  2. `distance` 
  3. `armor_yaw` 追踪装甲板的 `yaw` 角 `deg
  4. `armor_height` 追踪装甲板的高度  `mm`
- 基于先验知识
  1. `armor_r` （大概是 `250mm`）
- 零
  1. `v_tang` 切向速度 `mm/s``
  2. `v_norm` 法向速度 `mm/s`
  3. v_spin` 陀螺速度 `deg/s
  4. `a_lang` 切向加速度 `mm/s^2``
  5. `a_norm` 法向加速度 `mm/s^2`
  6. a_spin` 陀螺加速度 `deg/s^2`

## 针对小陀螺处理

- 在处理小陀螺问题上，最优策略是连续跟踪同一装甲，旋转周期内沿旋转方向对其连续击发，因为切换会产生较高切换成本与等待时间。
- 在一段角度区间内，令云台保持跟踪并发射子弹，在当预测显示该块装甲板将进入不可击中的区间（例如左右正负20度内，另外由于云台转速存在上限，所以可击打区间可以根据预测出的陀螺转速进行动态调整，加速之后就进行减小区间，甚至过快可以一直瞄准中心，不甩头打）后，将切换至下一块装甲板

## 状态机实现与流转

### 有限状态机与流转

- `Init` 初始化，用于 `RAII` 模式，全局只会用到一次
- `Sleep` 没看到目标，睡了
- `WakeUp` 看到某目标装甲板，估计器被唤醒
  - 流程
    1. 选择一个目标进行追踪（离第一人称视角屏幕中心最近的）
    2. 用解算结果初始化 `eskf` 的状态
- `Track` 跟踪状态，需要提前根据角度判断是否切换跟踪板并处理跳转逻辑，不跳转让 `fire` 为 `true`，跳转就 `false`
- `SWITCHING` 云台移动中
  - 此时不射击，设置 `fire` 为否
  
  - 使用 `current_yaw` 和 `target_yaw` 判断是否到位，并相应调整 `switch` 全局变量，同时流转至 `Aim` 状态
  
- `Lost` 这是我认为 `RM` 目前比较困扰的问题，子弹打击到装甲板上会把装甲板给打灭，导致出现一段时间的识别不连续
  - 解决的思路
    - 上交：训练了一版既可以识别灯条亮的装甲板，也可以识别灯条暗的装甲板，但是其他队伍目前没有这个方案
    - 其他：在 `Lost` 的时候只预测不更新，并设定一个时间阈值或者识别次数阈值，超过阈值认为彻底丢失

  - 需要维护一个 `LostTimeStamp` 变量，如果超时就进入 `Sleep` 状态

  - 在 `Lost` 的时间内，由于得不到测量，所以完全依靠模型进行预测，没有更新的步骤
- `Recovery` 类似 `WakeUp` ，从`Lost` 中恢复，需要用最新的观测来矫正测量，并且需要根据中间Lost的帧数字临时动态调小 `eskf` 的测量噪声矩阵（丢失帧数越多（小于上限），越要采信该次测量），使状态变量更加接近测量值

### 全局变量维护

- `fire` 当前是否开火
- `single_or_double` 单或双装甲板更新，用于设置 `eskf` 中测量噪声的大小

## 弹道补偿

- 重力作用
- 空气阻力作用
  - 使用简单的二阶阻力算法，不引入流体力学算法（弹丸小，速度慢，没必要）
- 延时补偿
  - 通讯延时
  - 开火延时
  - 子弹飞行延时

## 开火判断

直接根据 `fire` 进行判断

## 对 `LLM` 的一些要求和说明

1. 最重要的是保证基本功能正确实现优先，回答过程中，你可以大胆指出不合理和错误的地方，但是也要尽量减少发散思维，特别是对新算法的引入需要慎重。例如
   - 不该做
     - 跟我说 `yolo-pose` 模型与设备算力相关的问题，告诉我需要量化模型，选择其他轻量化模型，裁减模型，以及根据环境考虑在模型内增加不同光照数据集样本（比赛场景内灯光基本固定统一，现有模型识别成功率很高，设备算力足够）
     - 性能测试与调优相关话题，这部分不在重点讨论内容中，我会在具体实现算法及后续测试过程中注意这些问题
     - 复杂新算法的引入，例如认为简单空气阻力算法不好，需要引入更高级的算法，这对于这样的简单场景属于明显过分行为
     - 提醒我各种条件和变量需要量化，我难道不知道要量化吗[生气]，宝宝我是开玩笑的，我的意思我我不只是想让你生成代码，而是想更多先讨论问题本身而非具体的数值
   - 以上问题我们基本上已经进行了充分的调研，拥有较为成熟的理解，基本是可行方案，无需讨论，我们将重点放在对事物的本质理解和前期建模，建设部分中

# 与 `chatgpt` 沟通有感

0. 扇区这个词语用得真好，抄了
1. 使用极坐标是因为 `pnp` 算法对角度的测量方差较小，对距离的测量方差较大，使用极坐标可以进行区分
2. 3.3和3.4对我很有启发，会用
3. 在1中解释过了
4. 使用欧拉法是一个可行思路，对于其必要性我会进一步测试和论证
5. 7.2 “锁相”这个词语用得也很好（宝子，看来你的语文水平在我之上）
6. 7和8对我也很有启发，我可以通过记录switch所需要的时间，或者云台旋转的交速度上限，来作为我扇区大小的依据
7. “若第一帧是双板，顺手收敛 r、yaw。”这句话对我有点启发，实际上任何状态下看到双板，都会降低一点测量噪声提高可信度，帮助收敛
